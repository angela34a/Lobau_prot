---
title: "Protist communities along a surface-groundwater gradient in the Danube wetlands of Vienna" 
author:  "Angela Cukusic"
output:
  html_document:
    toc: true               # Table of contents
    toc_float: true         # Keep the table of contents floating on the page
    code_download: true     # Enable code download button
    code_copy: true         # Enable code copy button
    number_sections: true   # Numbering the sections
    theme: cerulean           # Choose a Bootstrap theme (check available themes)
    highlight: tango        # Syntax highlighting style 
---

```{r setup, include=FALSE}
# For width of code chunks and scroll bar 
options(width=250)

knitr::opts_chunk$set(eval = TRUE, 
                      echo = TRUE, 
                      cache = TRUE,
                      include = TRUE,
                      warning = FALSE,
                      collapse = FALSE,
                      message = FALSE,
                      engine = "R", 
                      # Chunks will always have R code, unless noted
                      error = TRUE)

```

# load packages
```{r}
library(tidyverse)
library(stringr)
library(decontam)
library(readxl)
library(vegan)
library(patchwork)
library(ggpmisc)
library(MASS)
library(microViz)
library(microbiome)
library(car)
library(corrplot)
library(interactions)
library(magrittr)
library(compositions)
library(microeco)


pal <- c("gray90", "gray20")
```


# load data
```{r}
# asv table
asv_table_SSU <-  read.csv("~/faks/poster_fungi/poster_fungi_jmf_2023-05-16/JMF-2301-09__all__rRNA_SSU_Euk_D__JMFR_MSHI_KP237/DADA2_counts_as_matrix.tsv", row.names=1,  check.names = FALSE, sep = "\t")
names(asv_table_SSU)<- sub("C","", names(asv_table_SSU))
# the first 78 samples are rna, so we take the second half
asv_table <- asv_table_SSU[, -c(1:78)]


# tax table
tax_table_SSU_RP2 <- read.delim("~/faks/poster_fungi/poster_fungi_jmf_2023-05-16/JMF-2301-09__all__rRNA_SSU_Euk_D__JMFR_MSHI_KP237/DADA2_ASVs.rRNA_SSU.PR2_reference.DADA2_classified.tsv", row.names=1)

#env table
env_data <- read_excel("~/faks/christina/data/data_angela/env_combined.xlsx") 
```



# remove the blanks
```{r}
jmf_blank_info <- read_excel("~/faks/christina/data/data_angela/jmf_2301_09_esw_d15.xlsx") 


jmf_blank_info <- 
# choose only dna  
  jmf_blank_info[ -c(1:78),] %>% 
  dplyr::select("JMF sample ID", "Sample description", "Date") %>% 
  rename("Sample_desc" = "Sample description",
          "JMF.ID" = "JMF sample ID") %>% 
# add blank or sample column  
  mutate(blank_sample = case_when(startsWith(Sample_desc, "Blank") ~ "blank",
                                             TRUE ~ "sample")) %>% 
  dplyr::filter(blank_sample == "sample")
 
 
# remove blanks from the asv table
asv_table <- asv_table[, colnames(asv_table) %in% jmf_blank_info$JMF.ID]
```




# connect sequincing id to sample_id
```{r}

# find the unique sample name first based on well id and sampling date
jmf_blank_info <- jmf_blank_info  %>% 
  mutate (well_id = case_when(startsWith(Sample_desc, "ESW") ~ "ESW_", 
                              startsWith(Sample_desc, "D05") ~ "D05p_", 
                              startsWith(Sample_desc, "D10") ~ "D10p_", 
                              startsWith(Sample_desc, "D15") ~ "D15p_"   )) %>% 
   mutate(sample_id = paste(well_id, Date)) %>% 
   dplyr::filter(well_id %in% c("ESW_", "D15p_"))
jmf_blank_info$sample_id <- gsub(" ", "", jmf_blank_info$sample_id)
jmf_blank_info$sample_id <- gsub("-", "", jmf_blank_info$sample_id)

# clean the Unbekannt one (JMF-2301-09-0109)that we do not know the id of
jmf_blank_info <- jmf_blank_info %>% dplyr::filter(Sample_desc != "Unbekannt")


env_lobau_final <- inner_join(jmf_blank_info, env_data, by = "sample_id")
rownames(env_lobau_final) <- env_lobau_final$JMF.ID

# rename the asv_table also
asv_table %>% 
  rownames_to_column("taxa") %>% 
  pivot_longer(cols = - taxa, names_to = "JMF.ID", values_to = "counts" ) %>% 
  left_join(., jmf_blank_info[,c("sample_id", "JMF.ID")], by = "JMF.ID") %>% 
  dplyr::select(!"JMF.ID") %>% 
# if there is replicates for the same sample_id add it up  
  group_by(taxa, sample_id) %>%
  summarise(counts = sum(counts)) %>%
  ungroup() %>% 
  pivot_wider(names_from = "sample_id", values_from = "counts") %>%
  column_to_rownames(var="taxa") -> asv_table


# the last column is NA -  the Unbekannt one?
# cannot be sure so just remove it
asv_table <- asv_table[, 1:46]
```


# clean up env data
```{r}
# since we removed the replicates from asv_table remove them from env_table

env_lobau_final %>% dplyr::filter(! JMF.ID %in% c("JMF-2301-09-0152", 
                                                   "JMF-2301-09-0147", 
                                                   "JMF-2301-09-0133",
                                                   "JMF-2301-09-0082", 
                                                   "JMF-2301-09-0083",
                                                   "JMF-2301-09-0084", 
                                                   "JMF-2301-09-0102", 
                                                   "JMF-2301-09-0106", 
                                                   "JMF-2301-09-0104", 
                                                   "JMF-2301-09-0139",
                                                   "JMF-2301-09-0100", 
                                                   "JMF-2301-09-0092") ) -> env_lobau_final

# since i know which ones are replicates it is easiest for me to just remove those jmfs



# add season category
env_lobau_final <- env_lobau_final %>% 
mutate(season = case_when ( 
     grepl('2021-05|2021-04|2022-04|2021-03|2022-03|2022-03|2022-05', Date) ~ "spring",
     grepl('2020-07|2022-08|2021-06|2022-06|2021-07|2022-08', Date)  ~ "summer",
     grepl('2020-09|2020-10|2022-10|2021-10|2022-11|2020-11|2021-11', Date) ~ "fall",
     grepl('2020-12|2021-12|2021-01|2022-01|2021-02|2022-02', Date) ~ "winter"   ))
```

We are left with 46 samples.


# clean up tax data
For now just remove the Metazoa, Fungi and unclassified divisions.
```{r}
tax_table <- tax_table_SSU_RP2 %>% 
  dplyr::filter(!Supergroup == "") %>% 
  dplyr::filter(!Division %in% c("Fungi", "Metazoa", "") )

# remove the taxa also from asv_table
asv_table <- asv_table[which(rownames(asv_table) %in% rownames(tax_table)) ,]
```




# Read numbers
```{r}
read_data <- asv_table %>% 
colSums() %>% # how many reads per sample (find sums per each column)
as.data.frame() %>% 
rownames_to_column("sample_id") %>% 
rename("reads" = ".") 

summary(read_data)
sd(read_data$reads)

boxplot(read_data$reads)


# mean: 17356  +- 10557.83



```

# Count numbers
Search for the count numbers - considering the elevated numbers of contaminated aquifers in comparison to pristine aquifers, it could be hypothesized there is a bigger count number in the surface water?
```{r}

# sample sizes
table(env_lobau_final$season, env_lobau_final$well_id.y)
# fairly similar sample sizes



asv_table %>% 
  rownames_to_column("taxa") %>% 
  pivot_longer(cols = -taxa, values_to = "counts", names_to = "sample_id") %>% 
  left_join(., env_lobau_final[, c("sample_id", "well_id.y", "season")], by = "sample_id") %>% 
  
# do not count by individual taxa, look at per sample count  
  group_by(sample_id) %>% 
  mutate(counts = sum(counts)) %>% 
  ungroup() %>% 
  
  ggplot(aes(x= well_id.y, y=counts, fill = well_id.y)) +
  geom_boxplot(alpha = 0.7) + 
  scale_y_log10(labels =  function(x) format(x, scientific = TRUE)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "gray"),
        legend.position =c(0.1, 0.9),
        axis.text.x = element_text(face = "bold", size = 12), 
        axis.text.y = element_text(face = "bold", size = 11), 
        axis.title = element_text(face = "bold", size = 14),
        legend.text = element_text(size = 11) ) +
  scale_fill_manual(values = pal) +
  labs(x = "Well ID", y = "Total 18S counts of sample",
       fill = "Well ID")   -> p_counts2


```

# by season
```{r}

asv_table %>% 
  rownames_to_column("taxa") %>% 
  pivot_longer(cols = -taxa, values_to = "counts", names_to = "sample_id") %>% 
  left_join(., env_lobau_final[, c("sample_id", "well_id.y", "season")], by = "sample_id") %>% 
  
# do not count by individual taxa, look at per sample count  
  group_by(sample_id) %>% 
  mutate(counts = sum(counts)) %>% 
  ungroup() %>% 
  
  ggplot(aes(x= season, y=counts, fill = well_id.y)) +
  geom_boxplot(alpha = 0.7) + 
  scale_y_log10(labels =  function(x) format(x, scientific = TRUE)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "gray"),
        legend.position =c(0.1, 0.9),
        axis.text.x = element_text(face = "bold", size = 12), 
        axis.text.y = element_text(face = "bold", size = 11), 
        axis.title = element_text(face = "bold", size = 14),
        legend.text = element_text(size = 11) ) +
  scale_fill_manual(values = pal) +
  labs(x = "Season", y = "Total 18S counts of sample",
       fill = "Well ID") +
  scale_x_discrete(limits = c("fall", "winter", "spring", "summer"))   -> p_counts
p_counts
```



# Rarefaction
```{r}

rrarefy(t(asv_table), sample = 4000) %>% t() %>% as.data.frame() -> asv_table_r

asv_table_r %>% colSums() %>%  plot()

# there is 6 sample that have less than 4000 counts
# remove them from asv_table
asv_table_r[,colSums(asv_table_r) == 4000] -> asv_table_r
# remove them from env data
env_lobau_final[env_lobau_final$sample_id %in%  colnames(asv_table_r),] -> env_lobau_final_r
```



# ordering
```{r}
env_lobau_final_r[order(env_lobau_final_r$sample_id), ] -> env_lobau_final_r
rownames(env_lobau_final_r) <- env_lobau_final_r$sample_id
identical(rownames(env_lobau_final_r), colnames(asv_table_r))
```


# Diversity
```{r}

shannondiv <- vegan::diversity(t(asv_table_r))
cbind(as.data.frame(shannondiv), env_lobau_final_r) %>% 
  as.data.frame() %>%
# plot
  ggplot(aes(x= season, y=shannondiv, fill = well_id.y)) +
  geom_boxplot(alpha = 0.7) + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "gray"),
        legend.position = c(0.9, 0.1),
        axis.text.x = element_text(face = "bold", size = 12), 
        axis.text.y = element_text(face = "bold", size = 11), 
        axis.title = element_text(face = "bold", size = 14)) +
  scale_fill_manual(values = pal) +
  labs(x = "Season", y = NULL, fill = "Well ID")  +
  scale_x_discrete(limits = c("fall", "winter", "spring", "summer")) -> p_div




```



```{r}
cbind(as.data.frame(shannondiv), env_lobau_final_r) %>% 
  as.data.frame() %>%
# plot
  ggplot(aes(x= well_id.y, y=shannondiv, fill = well_id.y)) +
  geom_boxplot(alpha = 0.7) + 
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "gray"),
        legend.position ="none",
        axis.text.x = element_text(face = "bold", size = 12), 
        axis.text.y = element_text(face = "bold", size = 11), 
        axis.title = element_text(face = "bold", size = 14)) +
  scale_fill_manual(values = pal) +
  labs(x = "Well ID", y = "Shannon's diversity index")  -> p_div2



p_div2 + p_div  + plot_layout(widths = c(1,2))
```


# nmds
```{r}

# do an ordination with a hellinger transformation 
sp.dist <-  vegdist(decostand( t(asv_table_r),
                               method = "hellinger") )



nmds <- metaMDS(sp.dist, k = 2, autotransform = FALSE)
plot(nmds)


as.data.frame(nmds$points) %>% 
  cbind(., env_lobau_final_r) %>% 
  
  ggplot(aes(x=MDS1,y=MDS2) ) +
  geom_point(aes( fill= well_id.y, shape = season), 
             size = 4, alpha = 0.6, stroke = 0.7) +  
# coloring  
  #scale_color_manual(values=pal) +
  #scale_fill_manual(values=pal) +
# add stress value
  annotate(geom="text",x=0.7, y=1.2, 
           label="stress =", color="black") +   
  annotate(geom="text", x=1.1, y=1.2, 
           label=round(nmds$stress,4), color="black") +
# ellipse  
  stat_ellipse(aes(colour = well_id.y), linewidth = 0.9) + 
  theme_bw() +
# visual parameters 
  theme(panel.grid = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "gray")) +
  labs(color = "Well ID", shape = "Season") +
  guides(fill = "none") + 
  scale_shape_manual(values = c(21, 22, 23, 24)) +
  scale_color_manual(values = pal) +
  scale_fill_manual(values = pal) 

```



```{r}

# well id
# first test assumption: equal dispersion
disp_aq <- betadisper( 
  vegdist(t(asv_table_r),
          method = "bray"), 
          env_lobau_final_r$well_id.y ) 

#p>0.05 is what we need - homogenous variances
anova(disp_aq) #no sign. differences in dispersion


# now test actual ordination
permanova_aq <- adonis2(t(asv_table_r) ~ 
          env_lobau_final_r$well_id.y , 
                         method = "bray" , 
                        permutations = 999)
permanova_aq # not sign


# season
# first test assumption: equal dispersion
disp_aq <- betadisper( 
  vegdist(t(asv_table_r),
          method = "bray"), 
          env_lobau_final_r$season ) 

#p>0.05 is what we need - homogenous variances
anova(disp_aq) #no sign. differences in dispersion


# now test actual ordination
permanova_aq <- adonis2(t(asv_table_r) ~ 
          env_lobau_final_r$season , 
                         method = "bray" , 
                        permutations = 999)
permanova_aq # not sign





adonis2(t(asv_table_r) ~ 
          env_lobau_final_r$season *  env_lobau_final_r$well_id.y, 
                         method = "bray" , 
                        permutations = 999)

```


# env variables


```{r}
my_labeller2 <- as_labeller(c(
  ec_uS_cm = "EC ~ (ÂµS/cm)",
  pH = "pH",
  oxygen_mg_L="O[2] ~ (mg/L)",
  doc_mg_L = "DOC ~ (mg/L)",
  dic_mg_L = "DIC ~ (mg/L)", 
  co2_uM = "CO[2] ~ (uM)"),
  default = label_parsed)

my_labeller1 <- as_labeller(c(
 atp_internal_pM = "ATP ~  (pM/L)",
  cells_per_mL = "TCC ~ (cells/mL)"),
  default = label_parsed)


        

```


```{r}
env_lobau_final_r %>% 
  dplyr::select("well_id.y", "pH", "ec_uS_cm", "oxygen_mg_L", "doc_mg_L", "dic_mg_L", 
                 "co2_uM") %>% 
  dplyr::filter(doc_mg_L < 30) %>% 
dplyr::filter(co2_uM < 1000) %>% 
pivot_longer(cols = -well_id.y, values_to = "values", names_to = "names") %>% 
  ggplot(aes(x= well_id.y, y= values, fill = well_id.y)) +
  geom_boxplot(alpha = 0.7) +
  facet_wrap(~names, scales = "free_y", ncol = 2,  
             strip.position = "left", 
             labeller = my_labeller2) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "none",
         axis.text.x = element_text(face = "bold", size = 12), 
        axis.text.y = element_text(face = "bold", size = 11), 
        axis.title = element_text(face = "bold", size = 14),
        plot.margin = unit(c(0, 0.5, 0, 0), "null"), 
        strip.text = element_text(size = 12)) +
  scale_fill_manual(values = pal) + 
  labs(y = NULL, x = "Well ID") -> plot_rest


env_lobau_final_r %>% 
  dplyr::select("well_id.y", "atp_internal_pM",
                "cells_per_mL") %>% 
pivot_longer(cols = -well_id.y, values_to = "values", names_to = "names") %>% 
  ggplot(aes(x= well_id.y, y= values, fill = well_id.y)) +
  geom_boxplot(alpha = 0.7) +
  scale_y_log10() +
   facet_wrap(~names, scales = "free_y", ncol = 2,  
              strip.position = "left", 
             labeller = my_labeller1) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "none",
         axis.text.x = element_blank(), 
        axis.text.y = element_text(face = "bold", size = 11), 
        axis.title = element_text(face = "bold", size = 14),
        axis.ticks.x = element_blank(),
        strip.text = element_text(size = 12)) +
  scale_fill_manual(values = pal) + 
  labs(y = NULL, x = NULL) -> plot_atp

plot_atp + plot_rest + plot_layout(heights = c(1,3))

```
# composition
```{r}
tax_table %>% 
 mutate(Class = ifelse(Class == "", paste0("Unclassified ", Division), Class)) -> tax_table

asv_table_r %>% 
  mutate_if(is.integer, as.numeric) %>% 
  mutate(class = tax_table$Class) %>%
  pivot_longer(cols = -class, 
               values_to = "abundance", 
               names_to = "sample") %>%
  left_join(.,env_lobau_final_r, by = c("sample" = "sample_id")) %>%  
  dplyr::select ("abundance", "class", "well_id.y") %>%
  mutate(well_id.y = as.factor(well_id.y),
         class = as.factor(class)) %>%  
# to find relative abundance within each category  
  dplyr::group_by(well_id.y) %>%
  mutate (rel_abund = abundance / sum(abundance)) %>%
  ungroup() %>%
# to sum up all the counts of one class from all the samples  
  dplyr::group_by(well_id.y, class) %>%
  summarise(rel_abund = sum(rel_abund)) %>%
  ungroup() %>%
# those very rare categorize as Diverse others 
  dplyr::group_by(well_id.y, class) %>%
  mutate(class = case_when(rel_abund< 0.015~ "Diverse others", 
                           TRUE ~ class)) %>%
  ungroup() %>%
# final regrouping after categorizing for Diverse others  
  dplyr::group_by(well_id.y, class) %>%
  summarise(rel_abund = sum(rel_abund)) %>%
  ungroup() %>%

# plot
  ggplot(aes(x = well_id.y, y = rel_abund, fill = class)) + 
  geom_bar(stat = "identity", color = "black",
           ) +
  #scale_fill_manual(values=c25) +
  theme(panel.grid = element_blank(), legend.position="right",
        legend.text = element_text(size = 6),      # Adjust the text size
        legend.title = element_text(size = 6),
        legend.key.size = unit(0.4, "cm"),
        axis.title = element_text(size=14,face="bold"),
        axis.text.y = element_text(size=10,face="bold"),
        axis.text.x = element_text(angle = 90, face = "bold")) + 
  labs(x = "Temperature categories",
       y = "Relative abundance", 
       fill = "Class") +
  guides(fill=guide_legend(ncol = 1)) 


```

```{r}

library(phyloseq)
library(microshades)

as.data.frame(env_lobau_final_r) %>% column_to_rownames("sample_id") -> env.data

ps_dna <- phyloseq(otu_table(as.matrix(asv_table_r), taxa_are_rows=TRUE), 
                   tax_table(as.matrix(tax_table) ) , 
                   sample_data(env.data ) )



 mdf_prep <- ps_dna %>%
         tax_glom("Class") %>%  
         merge_samples( group = "well_id.y") %>%
         phyloseq::transform_sample_counts(function(x) { x/sum(x) }) %>%
         psmelt() %>%
         filter(Abundance > 0) %>% 
         dplyr::select("Abundance", "Sample", "Division", "Class") %>%
         mutate(Division = as.factor(Division),
                Class = as.factor(Class))
 
# find the 4 most abundant division 
 mdf_prep %>% group_by(Division) %>% 
   summarise(Abundance = sum (Abundance)) %>% 
   slice_max(order_by =Abundance, n= 4) %>% 
   as.data.frame() %>% 
   dplyr::select("Division") %>% unique()
 # c( Ochrophyta, Ciliophora, Discoba, Conosa, Dinoflagellata,	Cryptophyta, Cercozoa )
 
 
 

color_objs_GP <- create_color_dfs(mdf_prep,selected_groups = c("Ochrophyta", 
                                                               "Ciliophora", 
                                                               "Discoba",
                                                               "Conosa", 
                                                               #"Dinoflagellata",
                                                               #"Cryptophyta",
                                                               "Cercozoa"
                                                               ) , cvd = TRUE, 
                                  group_level = "Division", subgroup_level = "Class",
                                  top_n_subgroups = 4)

# Extract
mdf_GP <- color_objs_GP$mdf
cdf_GP <- color_objs_GP$cdf


plot <- plot_microshades(mdf_GP, cdf_GP) +
  scale_y_continuous(labels = scales::percent, 
                     expand = expansion(0)) +
  theme_bw() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
         axis.text.x = element_text(face = "bold", size = 12), 
        axis.text.y = element_text(face = "bold", size = 11), 
        axis.title = element_text(face = "bold", size = 14)) 
plot


GP_legend <-custom_legend(mdf_GP, 
                          cdf_GP, 
                          group_level = "Division", 
                          subgroup_level = "Class",
                          legend_key_size = 1,
                          legend_text_size = 12)
plot_grid(plot, GP_legend,  rel_widths = c(1, .5))


```


```{r}

library(fantaxtic)



ps_2_rna <- merge_samples(ps_rna, group = "well_id") %>% 
  transform_sample_counts(.,function(x) x/sum(x) * 100)

top_nested <- nested_top_taxa(ps_2_rna,
                              grouping = "well_id",
                              top_tax_level = "Division",
                              nested_tax_level = "Class",
                              n_top_taxa = 8, 
                              n_nested_taxa = 5,
                              nested_merged_label = "Other <tax>")

plot_nested_bar(ps_obj = top_nested$ps_obj,
                top_level = "Division",
                nested_level = "Class",
                merged_clr = "grey60") +
  labs(x = NULL, title = NULL, y = "Relative abundance %") +
  scale_x_discrete( labels = c(
      "D15" = "  GW \nD15",
      "ESW" = " SF \nESW")) +
   theme(axis.text.x  = element_text(angle = 0, face = "bold", size = 15), 
         axis.title.y = element_text(face = "bold",size = 15),
         axis.text.y  = element_text(angle = 0, face = "bold", size = 15)) +
  scale_y_continuous(breaks = c(0, 0.25, 0.50, 0.75, 1.00), labels = c(0, 25, 50, 75, 100), expand = c(0,0)) + guides(shape = guide_legend (ncol = 2))
  
```


```{r}

asv_table_r %>% 
  mutate_if(is.integer, as.numeric) %>% 
  mutate(Division = tax_table$Division) %>%
  pivot_longer(cols = -Division, 
               values_to = "abundance", 
               names_to = "sample") %>%
  mutate(Division = as.factor(Division) ,
         sample = as.factor(sample))%>% 
  
  group_by(sample, Division) %>% 
  summarise(abundance = sum(abundance)) %>% 
  ungroup() %>% 
  
  left_join(.,env_lobau_final_r, by = c("sample" = "sample_id")) %>%  
  dplyr::select ("abundance", "Division", "well_id.y", "sample") %>% 
  mutate(well_id.y = as.factor(well_id.y)) %>%  
# to find relative abundance within each sampling site, but also within each sample  
  dplyr::group_by(sample) %>%
  mutate (rel_abund = abundance / sum(abundance)) %>%
  ungroup() %>%
  dplyr::filter(Division %in% c("Ochrophyta",
                                "Ciliophora",
                                "Dinoflagellata", 
                                "Cryptophyta",
                                "Conosa", 
                                "Cercozoa",
                                "Discoba")) %>% 
  mutate(Ecology  = case_when(Division %in% c( "Ciliophora", 
                                               "Cercozoa") ~ "consumer", 
                              Division %in% c("Discoba", "Dinoflagellata") ~  "myxothrop", 
                              Division %in% c("Conosa") ~  "parasite", 
                              Division %in% c("Ochrophyta", "Cryptophyta") ~ "phototroph")) %>% 
  dplyr::filter(rel_abund >0 ) %>% 

  ggplot(aes(y=reorder(Division, rel_abund), x=rel_abund)) + 
  geom_point(aes(color = Ecology, fill = Ecology), alpha =0.2, size = 3) +
  geom_point(aes(color = Ecology, fill = Ecology), alpha =0.2, size = 2) +
  geom_boxplot(aes(color = Ecology, fill = Ecology), alpha =0.3, outlier.colour = NA) +
  facet_wrap(~well_id.y, ncol = 1) + 
  theme_bw() +
  labs(x  = "Relative abundance %", y= NULL) +
  scale_fill_manual(values = c("blue", "orange2", "gold", "darkgreen")) + 
  scale_color_manual(values = c("blue", "orange2", "gold", "darkgreen")) +
  theme( legend.background = element_blank(),
        legend.box.background = element_rect(colour = "gray"),
        legend.position = c(0.8, 0.2), 
        panel.grid = element_blank(), 
        strip.text = element_text(size =10)) 

```

```{r}
asv_table_r %>% 
  mutate_if(is.integer, as.numeric) %>% 
  mutate(Division = tax_table$Division) %>%
  pivot_longer(cols = -Division, 
               values_to = "abundance", 
               names_to = "sample") %>%
  mutate(Division = as.factor(Division) ,
         sample = as.factor(sample))%>% 
  
  group_by(sample, Division) %>% 
  summarise(abundance = sum(abundance)) %>% 
  ungroup() %>% 
  
  left_join(.,env_lobau_final_r, by = c("sample" = "sample_id")) %>%  
  dplyr::select ("abundance", "Division", "well_id.y", "sample") %>% 
  mutate(well_id.y = as.factor(well_id.y)) %>%  
# to find relative abundance within each sampling site, but also within each sample  
  dplyr::group_by(sample) %>%
  mutate (rel_abund = abundance / sum(abundance)) %>%
  ungroup() %>%
  dplyr::filter(Division %in% c("Ochrophyta",
                                "Ciliophora",
                                "Dinoflagellata", 
                                "Cryptophyta",
                                "Conosa", 
                                "Cercozoa",
                                "Discoba")) %>% 
  
   dplyr::group_by(well_id.y, Division) %>%
  summarise(mean = mean(rel_abund) *100, sd = sd(rel_abund)*100) %>%
  ungroup() %>% 
  arrange(mean)
```

